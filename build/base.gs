function addAssertion(e,t,n,i,r){var a=SpreadsheetApp.openById(ScriptProperties.getProperty("test")).getSheetByName("DATA"),s=[a.getRange(2,7,a.getLastRow(),7)],o=generateUid(s),c="pegasus",u=doHash(t,c),l=doHash(n.trim(),c);return a.appendRow([new Date,e,u,l,i,r,o]),o}function buildAssertionJson(e,t,n){for(var i={"@context":"https://w3id.org/openbadges/v1",type:"Assertion",id:"",uid:"testID",recipient:{identity:"",type:"email",hashed:!0,salt:t},badge:"",verify:{type:"hosted",url:""},issuedOn:"1979-01-01"},r=SpreadsheetApp.openById(ScriptProperties.getProperty("test")).getSheetByName("DATA"),a=e,s=r.getRange("G:G"),o=s.getValues(),c=1;o[c-1]!=a;)c++;var u=r.getRange(c,1).getValue(),l=r.getRange(c,2).getValue(),g=r.getRange(c,4).getValue(),d=r.getRange(c,5).getValue(),h=r.getRange(c,6).getValue();return i.id=n+"?claimcode="+e,i.verify.url=i.id,i.uid=a,i.recipient.identity="sha256$"+g,i.issuedOn=Utilities.formatDate(u,"GMT","yyyy-MM-dd"),i.badge=n+"?badgename="+encodeURIComponent(l),d&&(i.expires=Utilities.formatDate(d,"GMT","yyyy-MM-dd")),h&&(i.evidence=h),i}function buildBadgeJson(e,t){var n={"@context":"https://w3id.org/openbadges/v1",id:"",type:"BadgeClass",name:"",description:"",image:"",criteria:"",issuer:""},i=SpreadsheetApp.openById(ScriptProperties.getProperty("test")).getSheetByName("BADGES"),r=i.getLastRow()-1,a=i.getRange(2,1,r,i.getLastColumn()),s=r+1;for(s;--s&&a.getCell(s,1).getValue()!==e;);return 0===s?!1:(n.id=t+"?badgename="+encodeURIComponent(e),n.name=e,n.description=a.getCell(s,2).getValue(),n.image=a.getCell(s,3).getValue(),n.criteria=a.getCell(s,4).getValue(),n.issuer=a.getCell(s,5).getValue(),n)}function checkPassword(e){function t(e){var t="Suffolk",i=n.PBKDF2(e,t,{keySize:16,iterations:50}),r="0ec8e829ba5b05b9e96680c571a1cb40d02584a51f47e23a36f433354e409fde2a2838b0ca60b624eaa5070a5348e3c28cc2f93115ac5d1a01fbea893bb1ba60";return i.toString()===r}var n=n||function(e,t){var n={},i=n.lib={},r=function(){},a=i.Base={extend:function(e){r.prototype=this;var t=new r;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},s=i.WordArray=a.extend({init:function(e,n){e=this.words=e||[],this.sigBytes=n!=t?n:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,n=e.words,i=this.sigBytes;if(e=e.sigBytes,this.clamp(),i%4)for(var r=0;e>r;r++)t[i+r>>>2]|=(n[r>>>2]>>>24-8*(r%4)&255)<<24-8*((i+r)%4);else if(65535<n.length)for(r=0;e>r;r+=4)t[i+r>>>2]=n[r>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-8*(n%4),t.length=e.ceil(n/4)},clone:function(){var e=a.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],i=0;t>i;i+=4)n.push(4294967296*e.random()|0);return new s.init(n,t)}}),o=n.enc={},c=o.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],i=0;e>i;i++){var r=t[i>>>2]>>>24-8*(i%4)&255;n.push((r>>>4).toString(16)),n.push((15&r).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],i=0;t>i;i+=2)n[i>>>3]|=parseInt(e.substr(i,2),16)<<24-4*(i%8);return new s.init(n,t/2)}},u=o.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],i=0;e>i;i++)n.push(String.fromCharCode(t[i>>>2]>>>24-8*(i%4)&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],i=0;t>i;i++)n[i>>>2]|=(255&e.charCodeAt(i))<<24-8*(i%4);return new s.init(n,t)}},l=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(u.stringify(e)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(e){return u.parse(unescape(encodeURIComponent(e)))}},g=i.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,i=n.words,r=n.sigBytes,a=this.blockSize,o=r/(4*a),o=t?e.ceil(o):e.max((0|o)-this._minBufferSize,0);if(t=o*a,r=e.min(4*t,r),t){for(var c=0;t>c;c+=a)this._doProcessBlock(i,c);c=i.splice(0,t),n.sigBytes-=r}return new s.init(c,r)},clone:function(){var e=a.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});i.Hasher=g.extend({cfg:a.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){g.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new d.HMAC.init(e,n).finalize(t)}}});var d=n.algo={};return n}(Math);return function(){var e=n,t=e.lib,i=t.WordArray,r=t.Hasher,a=[],t=e.algo.SHA1=r.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],r=n[1],s=n[2],o=n[3],c=n[4],u=0;80>u;u++){if(16>u)a[u]=0|e[t+u];else{var l=a[u-3]^a[u-8]^a[u-14]^a[u-16];a[u]=l<<1|l>>>31}l=(i<<5|i>>>27)+c+a[u],l=20>u?l+((r&s|~r&o)+1518500249):40>u?l+((r^s^o)+1859775393):60>u?l+((r&s|r&o|s&o)-1894007588):l+((r^s^o)-899497514),c=o,o=s,s=r<<30|r>>>2,r=i,i=l}n[0]=n[0]+i|0,n[1]=n[1]+r|0,n[2]=n[2]+s|0,n[3]=n[3]+o|0,n[4]=n[4]+c|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,i=8*e.sigBytes;return t[i>>>5]|=128<<24-i%32,t[(i+64>>>9<<4)+14]=Math.floor(n/4294967296),t[(i+64>>>9<<4)+15]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=r._createHelper(t),e.HmacSHA1=r._createHmacHelper(t)}(),function(){var e=n,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,n){e=this._hasher=new e.init,"string"==typeof n&&(n=t.parse(n));var i=e.blockSize,r=4*i;n.sigBytes>r&&(n=e.finalize(n)),n.clamp();for(var a=this._oKey=n.clone(),s=this._iKey=n.clone(),o=a.words,c=s.words,u=0;i>u;u++)o[u]^=1549556828,c[u]^=909522486;a.sigBytes=s.sigBytes=r,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e=n,t=e.lib,i=t.Base,r=t.WordArray,t=e.algo,a=t.HMAC,s=t.PBKDF2=i.extend({cfg:i.extend({keySize:4,hasher:t.SHA1,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var n=this.cfg,i=a.create(n.hasher,e),s=r.create(),o=r.create([1]),c=s.words,u=o.words,l=n.keySize,n=n.iterations;c.length<l;){var g=i.update(t).finalize(o);i.reset();for(var d=g.words,h=d.length,f=g,p=1;n>p;p++){f=i.finalize(f),i.reset();for(var v=f.words,y=0;h>y;y++)d[y]^=v[y]}s.concat(g),u[0]++}return s.sigBytes=4*l,s}});e.PBKDF2=function(e,t,n){return s.create(n).compute(e,t)}}(),t(e)}function createContentService(e){var t=ContentService.createTextOutput();t.setMimeType(ContentService.MimeType.JSON);var n=JSON.stringify(e);return Logger.log(n),t.setContent(n),t}function doHash(e,t){var n=n||function(e,t){var n={},i=n.lib={},r=function(){},a=i.Base={extend:function(e){r.prototype=this;var t=new r;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},s=i.WordArray=a.extend({init:function(e,n){e=this.words=e||[],this.sigBytes=n!=t?n:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,n=e.words,i=this.sigBytes;if(e=e.sigBytes,this.clamp(),i%4)for(var r=0;e>r;r++)t[i+r>>>2]|=(n[r>>>2]>>>24-8*(r%4)&255)<<24-8*((i+r)%4);else if(65535<n.length)for(r=0;e>r;r+=4)t[i+r>>>2]=n[r>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-8*(n%4),t.length=e.ceil(n/4)},clone:function(){var e=a.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],i=0;t>i;i+=4)n.push(4294967296*e.random()|0);return new s.init(n,t)}}),o=n.enc={},c=o.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],i=0;e>i;i++){var r=t[i>>>2]>>>24-8*(i%4)&255;n.push((r>>>4).toString(16)),n.push((15&r).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],i=0;t>i;i+=2)n[i>>>3]|=parseInt(e.substr(i,2),16)<<24-4*(i%8);return new s.init(n,t/2)}},u=o.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],i=0;e>i;i++)n.push(String.fromCharCode(t[i>>>2]>>>24-8*(i%4)&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],i=0;t>i;i++)n[i>>>2]|=(255&e.charCodeAt(i))<<24-8*(i%4);return new s.init(n,t)}},l=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(u.stringify(e)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(e){return u.parse(unescape(encodeURIComponent(e)))}},g=i.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,i=n.words,r=n.sigBytes,a=this.blockSize,o=r/(4*a),o=t?e.ceil(o):e.max((0|o)-this._minBufferSize,0);if(t=o*a,r=e.min(4*t,r),t){for(var c=0;t>c;c+=a)this._doProcessBlock(i,c);c=i.splice(0,t),n.sigBytes-=r}return new s.init(c,r)},clone:function(){var e=a.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});i.Hasher=g.extend({cfg:a.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){g.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new d.HMAC.init(e,n).finalize(t)}}});var d=n.algo={};return n}(Math);!function(e){for(var t=n,i=t.lib,r=i.WordArray,a=i.Hasher,i=t.algo,s=[],o=[],c=function(e){return 4294967296*(e-(0|e))|0},u=2,l=0;64>l;){var g;e:{g=u;for(var d=e.sqrt(g),h=2;d>=h;h++)if(!(g%h)){g=!1;break e}g=!0}g&&(8>l&&(s[l]=c(e.pow(u,.5))),o[l]=c(e.pow(u,1/3)),l++),u++}var f=[],i=i.SHA256=a.extend({_doReset:function(){this._hash=new r.init(s.slice(0))},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],r=n[1],a=n[2],s=n[3],c=n[4],u=n[5],l=n[6],g=n[7],d=0;64>d;d++){if(16>d)f[d]=0|e[t+d];else{var h=f[d-15],p=f[d-2];f[d]=((h<<25|h>>>7)^(h<<14|h>>>18)^h>>>3)+f[d-7]+((p<<15|p>>>17)^(p<<13|p>>>19)^p>>>10)+f[d-16]}h=g+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&u^~c&l)+o[d]+f[d],p=((i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22))+(i&r^i&a^r&a),g=l,l=u,u=c,c=s+h|0,s=a,a=r,r=i,i=h+p|0}n[0]=n[0]+i|0,n[1]=n[1]+r|0,n[2]=n[2]+a|0,n[3]=n[3]+s|0,n[4]=n[4]+c|0,n[5]=n[5]+u|0,n[6]=n[6]+l|0,n[7]=n[7]+g|0},_doFinalize:function(){var t=this._data,n=t.words,i=8*this._nDataBytes,r=8*t.sigBytes;return n[r>>>5]|=128<<24-r%32,n[(r+64>>>9<<4)+14]=e.floor(i/4294967296),n[(r+64>>>9<<4)+15]=i,t.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var e=a.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=a._createHelper(i),t.HmacSHA256=a._createHmacHelper(i)}(Math);var i=n.SHA256(e+t).toString();return i}function sendEmail(e,t,n,i){var r="http://www.ucslearningservices.co.uk/openbadges",a=r+"?claimcode="+i,s="Hi "+t+",\n\nCongratulations on obtaining the '"+e+"' Badge. To claim your badge visit \n\n"+a+"\n\nThis open badge is essentially a visual recognition of your learning journey which you can store and display online for others to view.The badge is stored inside a Mozilla Backpack. To find out how to set up your Mozilla Backpack, please visit http://www.openbadges.org\n\nMany Thanks\n\nThe Digital Learning Team (Learning Services)\n\nPlease visit our blog for more information on how we are using Open Badges at UCS - http://ucselevate.blogspot.co.uk.";return MailApp.sendEmail(n,"Claim your Badge - "+e+"!",s),!0}function isMatchInColumn(e,t,n){for(var i=e.getLastRow()+1;--i;)if(Logger.log(e.getCell(i,n).getValue()),e.getCell(i,n).getValue()===t)return i;return!1}function generateUid(e){for(var t=genRandomString(8,16),n=e.length;n--;)t===e[n]&&(n=e.length,t=genRandomString(8,16));return t}function genRandomString(e,t){t=t||36;for(var n,i="";i.length<e;)n=Math.random().toString(t).slice(2),i+=n.slice(0,Math.min(n.length,e-i.length));return i.toUpperCase()}function getBadgesAsArrays(){var e=SpreadsheetApp.openById(ScriptProperties.getProperty("test")).getSheetByName("BADGES");if(e.getLastRow()<=1)return[];var t=e.getRange(2,1,e.getLastRow()-1,4).getValues();return t}function getBadgeList(e){var t=getBadgesAsArrays(),n=[];for(i in t)n.push(t[i][e]);return n}function valueExists(e,t){var n=e.trim().toLowerCase(),i=getBadgeList(t);for(var r in i)if(i[r].trim().toLowerCase()===n)return!0;return!1}function badgeExists(e){var t=[e.badgename,e.badgedesc,e.badgeimage];for(var n in t)if(valueExists(t[n],n))return t[0]+" already exists. ";return""}function doGet(e){var t,n="pegasus",i="https://script.google.com/macros/s/AKfycbwhWomQjaALphGQ1JeSQhfO0VsaZxYBRl-xnEWp328wB4wFlg_T/exec";if(e.parameter.claimcode){var r=buildAssertionJson(e.parameter.claimcode,n,i);return t=createContentService(r)}if(e.parameter.badgename){var a=buildBadgeJson(e.parameter.badgename,i);return a?t=createContentService(a):ContentService.createTextOutput("Badge not found")}return HtmlService.createHtmlOutputFromFile("ui.html").setSandboxMode(HtmlService.SandboxMode.IFRAME)}function doPost(e){return ContentService.createTextOutput("Badges issued.")}function readFile(e){var t=e.selectedbadge,n=0,i=0,r=e.expiration,a=e.evidence,s=e.file;if(s){var o=s.getDataAsString(),c=o.split("\n"),u="";for(line=c.length-1;--line;){var l=c[line].split(","),g=l[0],d=l[1].trim(),h="";if(h+=validateInput(g,["text"]),h+=validateInput(d,["email"]))u+="Failed to add badge for "+g+": "+h,i++,Logger.log("name: "+g),Logger.log("email: "+d);else{var f=addAssertion(t,g,d,r,a);sendEmail(t,g,d,f)?n++:(i++,Logger.log("Failed to send email to recipient with UID: "+f))}}return 0===i?"":n+" ok, "+i+" fail. \n"+u}return"file not found"}function submitForm(e){var t="",n="";return checkPassword(e.password)?(t+=addNewBadge(e))?t:(valueExists(e.selectedbadge,0)&&(validateInput(e.file,["empty"])?(t+=validateInput(e.name,["text"]),t+=validateInput(e.email,["email"]),t+=validateInput(e.evidence,["url"],!0),t||(n=addAssertion(e.selectedbadge,e.name,e.email,e.expiration,e.evidence),sendEmail(e.selectedbadge,e.name,e.email,n)||(t+="Unable to email recipient. "))):t+=readFile(e)),t):"Server error: Password incorrect. "}function addNewBadge(e){var t="";if(!validateInput(e.badgename,["empty"])&&(t+=validateInput(e.badgename,["text"]),t+=validateInput(e.badgedesc,["text"]),t+=validateInput(e.badgeimage,["url","png"]),t+=validateInput(e.badgecriteria,["url"]),t+=validateInput(e.badgeissuer,["url","json"]),t+=badgeExists(e),!t)){var n=SpreadsheetApp.openById(ScriptProperties.getProperty("test")).getSheetByName("BADGES");return n.appendRow([e.badgename,e.badgedesc,e.badgeimage,e.badgecriteria,e.badgeissuer]),t}return t}function validateInput(e,t,n){var i=validateValue(e,"empty");if(i)n&&(i="");else for(test in t)i+=validateValue(e,t[test]);return i}function validateValue(e,t){var n=/^https?\:\/\/[\w\/.]+$/,i=/\.png$/,r=/\.json$/,a=/\.csv$/,s=/\@.*\..*$/,o=/^[A-Za-z\s]+$/,c="";switch(t){case"url":Logger.log("checking input against URL rule"),n.test(e)||(c=e+": Must be valid URL. ");break;case"png":Logger.log("checking input against PNG rule"),i.test(e)||(c=e+": Image must be of type PNG. ");break;case"email":Logger.log("checking input against Email rule"),s.test(e)||(c=e+": Not a valid email address, must contain . and @. ");break;case"json":Logger.log("checking input against JSON rule"),r.test(e)||(c=e+": Not a valid JSON file. ");break;case"csv":Logger.log("checking input against CSV rule"),a.test(e)||(c=e+": Not a valid CSV file. ");break;default:case"text":Logger.log("checking input against TEXT rule"),o.test(e)||(c=e+"Text must contain only letters. ");case"empty":Logger.log("checking field has input"),0===e.length&&(c=e+"Field cannot be empty. ")}return c}